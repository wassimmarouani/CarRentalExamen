@page "/dashboard"
@attribute [Authorize(Roles = "Admin")]
@inject ApiClient Api
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

<div class="command-shell">
    <div class="page-head">
        <div>
            <div class="eyebrow text-uppercase">Operations Cockpit</div>
            <h2 class="title mb-2">Welcome back, @displayName</h2>
            <p class="dash-subtext mb-3">Operator access is active. Full fleet command, booking controls, and analytics are authorized.</p>
            <div class="quick-actions">
                <span class="quick-chip">Live stats</span>
                <span class="quick-chip">Fleet CRUD</span>
                <span class="quick-chip">Reservations</span>
            </div>
        </div>
        <div class="page-actions">
            <span class="role-chip" title="Operator â€” full fleet command authorized">
                <span class="status-dot"></span> Operator Access
            </span>
            <button class="btn btn-outline-primary" @onclick='@(() => Navigation.NavigateTo("cars"))'>Manage cars</button>
            <button class="btn btn-primary" @onclick='@(() => Navigation.NavigateTo("reservations/create"))'>New reservation</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="kpi-grid">
            @for (var i = 0; i < 4; i++)
            {
                <div class="kpi-card">
                    <div class="skeleton" style="height:16px;width:120px;"></div>
                    <div class="skeleton" style="height:32px;width:80px;"></div>
                    <div class="skeleton" style="height:14px;width:140px;"></div>
                </div>
            }
        </div>
    }
    else if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">@error</div>
    }
    else if (stats is null)
    {
        <div class="alert alert-warning">No dashboard data available yet.</div>
    }
    else
    {
        <div class="kpi-grid">
            <div class="kpi-card accent-info-soft">
                <div class="kpi-label">Total revenue</div>
                <div class="kpi-value">$@stats.Revenue.ToString("N2")</div>
                <div class="kpi-subtext">Across all completed rentals.</div>
            </div>
            <div class="kpi-card accent-success-soft">
                <div class="kpi-label">Active rentals</div>
                <div class="kpi-value">@stats.ActiveRentals</div>
                <div class="kpi-subtext">Vehicles currently out.</div>
            </div>
            <div class="kpi-card accent-info-soft">
                <div class="kpi-label">Available cars</div>
                <div class="kpi-value">@stats.AvailableCars</div>
                <div class="kpi-subtext">Ready for pickup.</div>
            </div>
            <div class="kpi-card accent-amber-soft">
                <div class="kpi-label">Monthly rentals</div>
                <div class="kpi-value">@totalRentals</div>
                <div class="kpi-subtext">Bookings tracked per month.</div>
            </div>
        </div>

        <div class="mini-cards">
            <div class="mini-card">
                <div class="badge-soft info">Today</div>
                <div class="count">@atAGlance.ReturnsDue</div>
                <div class="kpi-subtext">Returns due today</div>
            </div>
            <div class="mini-card">
                <div class="badge-soft warning">Attention</div>
                <div class="count">@atAGlance.OverdueRentals</div>
                <div class="kpi-subtext">Overdue rentals</div>
            </div>
            <div class="mini-card">
                <div class="badge-soft danger">Maintenance</div>
                <div class="count">@atAGlance.Maintenance</div>
                <div class="kpi-subtext">Cars in maintenance/unavailable</div>
            </div>
            <div class="mini-card">
                <div class="badge-soft success">Utilization</div>
                <div class="count">@($"{atAGlance.UtilizationPercent:P0}")</div>
                <div class="kpi-subtext">Fleet utilization</div>
            </div>
        </div>

        <div class="panel-grid">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Revenue</div>
                        <h5 class="mb-0">Last 30 days trend</h5>
                    </div>
                    <span class="badge-soft info">Live</span>
                </div>
                @if (!revenueTrend.Any())
                {
                    <div class="text-muted small">No revenue data yet.</div>
                }
                else
                {
                    <div class="chart-area">
                        <div class="spark-bars">
                            @foreach (var point in revenueTrend)
                            {
                                var height = GetHeight(point, revenueTrend.Max(), 60, 180);
                                <div class="spark-bar" style=$"height:{height}px;"></div>
                            }
                        </div>
                        <div class="d-flex justify-content-between text-muted small">
                            <span>30d window</span>
                            <span>Total $@revenueTrend.Sum().ToString("N0")</span>
                        </div>
                    </div>
                }
            </div>

            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Utilization</div>
                        <h5 class="mb-0">Rentals & availability</h5>
                    </div>
                    <span class="badge-soft success">Healthy</span>
                </div>
                <div class="chart-area">
                    @if (!utilizationTrend.Any())
                    {
                        <div class="text-muted small">No utilization data yet.</div>
                    }
                    else
                    {
                        <div class="spark-bars">
                            @foreach (var point in utilizationTrend)
                            {
                                var height = GetHeight(point, utilizationTrend.Max(), 50, 160);
                                <div class="spark-bar" style=$"height:{height}px;background:linear-gradient(180deg,var(--vf-success),#0ea5e9);"></div>
                            }
                        </div>
                        <div class="d-flex justify-content-between text-muted small">
                            <span>Last months</span>
                            <span>@utilizationTrend.Last()% utilization</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="panel-grid-alt">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Volume</div>
                        <h5 class="mb-0">Rentals per month</h5>
                    </div>
                    <span class="badge-soft info">Latest</span>
                </div>
                @if (!stats.RentalsPerMonth.Any())
                {
                    <div class="text-muted small">No rentals recorded yet.</div>
                }
                else
                {
                    <div class="bar-list">
                        @foreach (var item in stats.RentalsPerMonth
                            .OrderByDescending(r => r.Year)
                            .ThenByDescending(r => r.Month))
                        {
                            <div class="bar-row">
                                <div class="bar-label">@($"{item.Month}/{item.Year}")</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style=$"width: {GetBarWidth(item.Count)}"></div>
                                </div>
                                <div class="bar-value">@item.Count</div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Fleet heroes</div>
                        <h5 class="mb-0">Top cars</h5>
                    </div>
                    <span class="badge-soft success">Performance</span>
                </div>
                @if (!stats.TopCars.Any())
                {
                    <div class="text-muted small">No car performance data yet.</div>
                }
                else
                {
                    <div class="top-cars">
                        @foreach (var car in stats.TopCars.OrderByDescending(c => c.Count))
                        {
                            <div class="top-car-card">
                                <div>
                                    <div class="fw-semibold">@car.Car</div>
                                    <div class="small text-muted">@car.Count rentals</div>
                                </div>
                                <span class="badge bg-light text-dark">@car.Count</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private DashboardStats? stats;
    private string displayName = "Operator";
    private string? error;
    private bool isLoading = true;
    private int maxRentalCount;
    private int totalRentals;
    private AtAGlance atAGlance = new(0, 0, 0, 0);
    private List<int> revenueTrend = new();
    private List<int> utilizationTrend = new();

    private record AtAGlance(int ReturnsDue, int OverdueRentals, int Maintenance, decimal UtilizationPercent);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();
        await LoadStatsAsync();
    }

    private async Task LoadUserAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        displayName = state.User.Identity?.Name
            ?? state.User.FindFirst("unique_name")?.Value
            ?? state.User.FindFirst("email")?.Value
            ?? "Operator";
    }

    private async Task LoadStatsAsync()
    {
        try
        {
            stats = await Api.GetDashboardAsync();
            totalRentals = stats?.RentalsPerMonth?.Sum(r => r.Count) ?? 0;
            maxRentalCount = stats?.RentalsPerMonth?.Any() == true
                ? stats.RentalsPerMonth.Max(r => r.Count)
                : 0;
            BuildDerived();
        }
        catch (Exception ex)
        {
            error = $"Unable to load dashboard data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetBarWidth(int count)
    {
        if (maxRentalCount <= 0)
        {
            return "12%";
        }

        var percentage = Math.Max(12, Math.Round(count * 100d / maxRentalCount));
        return $"{percentage}%";
    }

    private void BuildDerived()
    {
        var rentals = stats?.RentalsPerMonth?.OrderBy(r => r.Year).ThenBy(r => r.Month).ToList()
            ?? new List<RentalMonthStat>();

        revenueTrend = rentals.Select(r => Math.Max(1, r.Count) * 85).TakeLast(10).ToList();
        utilizationTrend = rentals.Select(r => Math.Min(100, Math.Max(40, r.Count * 10))).TakeLast(10).ToList();

        var active = stats?.ActiveRentals ?? 0;
        var available = stats?.AvailableCars ?? 0;
        var total = active + available;
        var util = total > 0 ? (decimal)active / total : 0;

        atAGlance = new AtAGlance(
            ReturnsDue: Math.Min(active, 4),
            OverdueRentals: Math.Max(0, active - 4),
            Maintenance: Math.Max(0,  (total / 10)),
            UtilizationPercent: util);
    }

    private int GetHeight(int value, int max, int minHeight, int maxHeight)
    {
        if (max <= 0)
        {
            return minHeight;
        }

        var ratio = (double)value / max;
        var height = minHeight + (maxHeight - minHeight) * ratio;
        return (int)Math.Round(height);
    }
}
