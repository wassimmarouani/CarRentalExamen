@page "/register"
@attribute [AllowAnonymous]
@layout AuthLayout
@inject ApiClient Api
@inject NavigationManager Navigation
@implements IDisposable
@using System.Linq
@using CarRentalExamen.Core.DTOs.Auth

<PageTitle>Register - Velocity Fleet</PageTitle>

<div class="auth-grid auth-grid-premium">
    <div class="auth-aside">
        <div class="brand-lockup mb-4">
            <div class="brand-mark">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                    <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                    <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5" />
                </svg>
            </div>
            <div>
                <div class="eyebrow text-soft">Velocity Fleet</div>
                <div class="brand-title">Car Rental</div>
                <div class="small text-soft">Customer registration</div>
            </div>
            <span class="badge-secure ms-auto">
                <span class="status-dot"></span>
                Secure Portal
            </span>
        </div>

        <div class="pill mb-3">
            <span class="pulse-dot pulse-dot-accent"></span>
            New Customer Setup
        </div>

        <h2>Join Velocity Fleet</h2>
        <p class="mb-4">Create your account to browse our fleet, make reservations, and manage your rentals.</p>

        <div class="auth-bullets">
            <div class="auth-bullet">
                <span class="bullet-dot">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                        <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                        <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"></path>
                    </svg>
                </span>
                <div>
                    <div class="fw-semibold">Browse Vehicles</div>
                    <div class="small">Explore our wide selection of cars available for rent.</div>
                </div>
            </div>
            <div class="auth-bullet">
                <span class="bullet-dot">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
                        <path d="M16 3v4"></path>
                        <path d="M8 3v4"></path>
                        <path d="M4 11h16"></path>
                        <path d="M8 15h2v2h-2z"></path>
                    </svg>
                </span>
                <div>
                    <div class="fw-semibold">Easy Reservations</div>
                    <div class="small">Book your next ride in just a few clicks.</div>
                </div>
            </div>
            <div class="auth-bullet">
                <span class="bullet-dot">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                        <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                    </svg>
                </span>
                <div>
                    <div class="fw-semibold">Manage Your Rentals</div>
                    <div class="small">View and track all your reservations in one place.</div>
                </div>
            </div>
        </div>

        <div class="stat-strip">
            <div class="stat-chip">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                    <path d="M9 12l2 2l4 -4"></path>
                </svg>
                Instant Setup
            </div>
            <div class="stat-chip">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
                    <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"></path>
                </svg>
                Wide Selection
            </div>
            <div class="stat-chip">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
                    <path d="M3.6 9h16.8"></path>
                    <path d="M3.6 15h16.8"></path>
                    <path d="M11.5 3a17 17 0 0 0 0 18"></path>
                    <path d="M12.5 3a17 17 0 0 1 0 18"></path>
                </svg>
                24/7 Support
            </div>
        </div>
    </div>

    <div class="auth-card auth-card-premium">
        <div class="auth-card-header">
            <div class="auth-card-title">
                <div class="authority-chip">
                    <span class="status-dot"></span>
                    Customer Registration
                </div>
                <div class="eyebrow mt-2">Registration</div>
                <h4>Create your account</h4>
                <p class="auth-subtext">Set up your customer profile to start renting.</p>
            </div>
            <div class="auth-nav">
                <span class="auth-nav-text">Already registered?</span>
                <a href="/login" class="auth-nav-link">Sign in</a>
            </div>
        </div>

        @if (showSuccessToast)
        {
            <div class="success-toast" role="status">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                    <path d="M9 12l2 2l4 -4"></path>
                </svg>
                Account created. Redirecting to browse cars...
            </div>
        }

        <EditForm EditContext="registerEditContext" OnValidSubmit="HandleRegister" class="auth-form" novalidate>
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(error))
            {
                <div class="alert soft-alert" role="alert">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v2m0 4v.01"></path>
                        <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"></path>
                    </svg>
                    @error
                </div>
            }

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="reg-firstname">First Name</label>
                    <div class="input-shell @GetInputState(registerModel, nameof(registerModel.FirstName))">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                            </svg>
                        </span>
                        <InputText id="reg-firstname" class="form-control" @bind-Value="registerModel.FirstName"
                                   autocomplete="given-name" placeholder="First name" aria-required="true" />
                    </div>
                    <ValidationMessage For="@(() => registerModel.FirstName)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="reg-lastname">Last Name</label>
                    <div class="input-shell @GetInputState(registerModel, nameof(registerModel.LastName))">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                            </svg>
                        </span>
                        <InputText id="reg-lastname" class="form-control" @bind-Value="registerModel.LastName"
                                   autocomplete="family-name" placeholder="Last name" aria-required="true" />
                    </div>
                    <ValidationMessage For="@(() => registerModel.LastName)" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="reg-username">Username</label>
                <div class="input-shell @GetInputState(registerModel, nameof(registerModel.Username))">
                    <span class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                            <path d="M12 10m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
                            <path d="M6.168 18.849a4 4 0 0 1 3.832 -2.849h4a4 4 0 0 1 3.834 2.855"></path>
                        </svg>
                    </span>
                    <InputText id="reg-username" class="form-control" @bind-Value="registerModel.Username"
                               autocomplete="username" placeholder="Choose a username" aria-required="true" />
                </div>
                <ValidationMessage For="@(() => registerModel.Username)" />
            </div>

            <div class="mb-3">
                <label class="form-label" for="reg-email">Email Address</label>
                <div class="input-shell @GetInputState(registerModel, nameof(registerModel.Email))">
                    <span class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
                            <path d="M3 7l9 6l9 -6"></path>
                        </svg>
                    </span>
                    <InputText id="reg-email" type="email" class="form-control" @bind-Value="registerModel.Email"
                               autocomplete="email" placeholder="Enter your email" aria-required="true" />
                </div>
                <ValidationMessage For="@(() => registerModel.Email)" />
            </div>

            <div class="mb-3">
                <label class="form-label" for="reg-phone">Phone Number</label>
                <div class="input-shell @GetInputState(registerModel, nameof(registerModel.Phone))">
                    <span class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2"></path>
                        </svg>
                    </span>
                    <InputText id="reg-phone" class="form-control" @bind-Value="registerModel.Phone"
                               autocomplete="tel" placeholder="Phone number" aria-required="true" />
                </div>
                <ValidationMessage For="@(() => registerModel.Phone)" />
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="reg-cin">ID / Passport Number</label>
                    <div class="input-shell @GetInputState(registerModel, nameof(registerModel.CinOrPassport))">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
                                <path d="M9 12h6"></path>
                                <path d="M9 16h6"></path>
                            </svg>
                        </span>
                        <InputText id="reg-cin" class="form-control" @bind-Value="registerModel.CinOrPassport"
                                   placeholder="ID or Passport number" aria-required="true" />
                    </div>
                    <ValidationMessage For="@(() => registerModel.CinOrPassport)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="reg-license">Driver's License</label>
                    <div class="input-shell @GetInputState(registerModel, nameof(registerModel.LicenseNumber))">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
                                <path d="M7 12h.01"></path>
                                <path d="M11 12h6"></path>
                            </svg>
                        </span>
                        <InputText id="reg-license" class="form-control" @bind-Value="registerModel.LicenseNumber"
                                   placeholder="License number" aria-required="true" />
                    </div>
                    <ValidationMessage For="@(() => registerModel.LicenseNumber)" />
                </div>
            </div>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <label class="form-label" for="reg-password">Password</label>
                    <span class="input-hint">Strong password recommended</span>
                </div>
                <div class="input-shell @GetInputState(registerModel, nameof(registerModel.Password))">
                    <span class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"></path>
                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"></path>
                            <path d="M8 11v-4a4 4 0 1 1 8 0v4"></path>
                        </svg>
                    </span>
                    <InputText id="reg-password" type="@(showPassword ? "text" : "password")" class="form-control" @bind-Value="registerModel.Password"
                               autocomplete="new-password" placeholder="Create a password" aria-required="true" />
                    <button type="button" class="password-toggle" @onclick="TogglePassword" aria-pressed="@showPassword" aria-label="Toggle password visibility">
                        @if (showPassword)
                        {
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3l18 18"></path>
                                <path d="M10.58 10.58a2 2 0 0 0 2.83 2.83"></path>
                                <path d="M9.88 5.08a10 10 0 0 1 9.05 5.44a9.97 9.97 0 0 1 -1.5 2.14"></path>
                                <path d="M6.15 6.15a10.06 10.06 0 0 0 -3.15 4.37a10 10 0 0 0 12.65 4.99"></path>
                            </svg>
                        }
                        else
                        {
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4 -8 11 -8s11 8 11 8s-4 8 -11 8s-11 -8 -11 -8"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        }
                    </button>
                </div>
                <ValidationMessage For="@(() => registerModel.Password)" />
            </div>

            <div class="mb-3">
                <label class="form-label" for="reg-confirm">Confirm Password</label>
                <div class="input-shell @(string.IsNullOrEmpty(confirmPasswordError) ? string.Empty : "input-error")">
                    <span class="input-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3"></path>
                            <path d="M12 11m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                            <path d="M12 12l0 2.5"></path>
                        </svg>
                    </span>
                    <InputText id="reg-confirm" type="@(showConfirmPassword ? "text" : "password")" class="form-control" @bind-Value="confirmPassword"
                               autocomplete="new-password" placeholder="Confirm your password" aria-required="true" />
                    <button type="button" class="password-toggle" @onclick="ToggleConfirmPassword" aria-pressed="@showConfirmPassword" aria-label="Toggle confirmation visibility">
                        @if (showConfirmPassword)
                        {
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3l18 18"></path>
                                <path d="M10.58 10.58a2 2 0 0 0 2.83 2.83"></path>
                                <path d="M9.88 5.08a10 10 0 0 1 9.05 5.44a9.97 9.97 0 0 1 -1.5 2.14"></path>
                                <path d="M6.15 6.15a10.06 10.06 0 0 0 -3.15 4.37a10 10 0 0 0 12.65 4.99"></path>
                            </svg>
                        }
                        else
                        {
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4 -8 11 -8s11 8 11 8s-4 8 -11 8s-11 -8 -11 -8"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        }
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(confirmPasswordError))
                {
                    <div class="text-danger small mt-1" role="alert">@confirmPasswordError</div>
                }
            </div>

            @{
                var strength = Strength;
            }
            <div class="password-meta" aria-live="polite">
                <div class="strength-meter">
                    <div class="strength-meter-track">
                        <div class="strength-meter-bar strength-@strength.Label.ToLowerInvariant()" style="width: @strength.Percent%;"></div>
                    </div>
                    <span class="strength-label">@strength.Label password</span>
                </div>
                <ul class="password-requirements">
                    <li class="@RequirementClass(strength.HasLength)">At least 8 characters</li>
                    <li class="@RequirementClass(strength.HasCase)">Upper & lower case</li>
                    <li class="@RequirementClass(strength.HasNumber)">Include a number</li>
                    <li class="@RequirementClass(strength.HasSymbol)">Include a symbol</li>
                    <li class="@RequirementClass(strength.HasLong)">12+ characters for best score</li>
                </ul>
            </div>

            <button class="btn btn-primary w-100 btn-lg" type="submit" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner"></span>
                    <span>Creating account...</span>
                }
                else
                {
                    <span>Create Account</span>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14"></path>
                        <path d="M13 18l6 -6"></path>
                        <path d="M13 6l6 6"></path>
                    </svg>
                }
            </button>
        </EditForm>

        <div class="auth-footer" role="status">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                <path d="M9 12l2 2l4 -4"></path>
            </svg>
            <span>Your account is created instantly. Start browsing and reserving cars right away.</span>
        </div>
    </div>
</div>

@code {
    private RegisterCustomerRequestDto registerModel = new();
    private EditContext? registerEditContext;
    private string confirmPassword = string.Empty;
    private string? error;
    private string? confirmPasswordError;
    private string? returnUrl;
    private bool isLoading;
    private bool showPassword;
    private bool showConfirmPassword;
    private bool showSuccessToast;

    private record PasswordStrength(string Label, int Percent, bool HasLength, bool HasCase, bool HasNumber, bool HasSymbol, bool HasLong);

    protected override void OnInitialized()
    {
        registerEditContext = new EditContext(registerModel);
        registerEditContext.OnFieldChanged += RegisterFieldChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        CaptureReturnUrl();
        var existingToken = await Api.GetCurrentTokenAsync();
        if (!string.IsNullOrWhiteSpace(existingToken))
        {
            Navigation.NavigateTo("/customer", true);
        }
    }

    private void RegisterFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        error = null;
        UpdateConfirmPasswordError();
        registerEditContext?.Validate();
    }

    private string RequirementClass(bool met) => met ? "requirement met" : "requirement";

    private PasswordStrength Strength => EvaluatePassword(registerModel.Password);

    private PasswordStrength EvaluatePassword(string? password)
    {
        password ??= string.Empty;
        var hasLength = password.Length >= 8;
        var hasLong = password.Length >= 12;
        var hasCase = password.Any(char.IsUpper) && password.Any(char.IsLower);
        var hasNumber = password.Any(char.IsDigit);
        var hasSymbol = password.Any(ch => char.IsSymbol(ch) || char.IsPunctuation(ch));

        var score = 0;
        if (hasLength) score++;
        if (hasLong) score++;
        if (hasCase) score++;
        if (hasNumber) score++;
        if (hasSymbol) score++;

        var label = score switch
        {
            >= 4 => "Strong",
            3 => "Good",
            2 => "Fair",
            _ => "Weak"
        };

        var percent = Math.Clamp(score, 0, 5) * 20;

        return new PasswordStrength(label, percent, hasLength, hasCase, hasNumber, hasSymbol, hasLong);
    }

    private string GetInputState(object model, string fieldName)
    {
        if (registerEditContext is null)
        {
            return string.Empty;
        }

        var field = new FieldIdentifier(model, fieldName);
        var hasError = registerEditContext.GetValidationMessages(field).Any();
        var isTouched = registerEditContext.IsModified(field);

        if (hasError)
        {
            return "input-error";
        }

        return isTouched ? "input-valid" : string.Empty;
    }

    private void UpdateConfirmPasswordError()
    {
        confirmPasswordError = string.IsNullOrWhiteSpace(registerModel.Password) || string.IsNullOrWhiteSpace(confirmPassword)
            ? null
            : registerModel.Password == confirmPassword ? null : "Passwords do not match.";
    }

    private void TogglePassword() => showPassword = !showPassword;
    private void ToggleConfirmPassword() => showConfirmPassword = !showConfirmPassword;

    private void CaptureReturnUrl()
    {
        var query = Navigation.ToAbsoluteUri(Navigation.Uri).Query;
        if (string.IsNullOrWhiteSpace(query))
        {
            return;
        }

        foreach (var pair in query.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries))
        {
            var kvp = pair.Split('=', 2, StringSplitOptions.TrimEntries);
            if (kvp.Length == 2 && kvp[0].Equals("returnUrl", StringComparison.OrdinalIgnoreCase))
            {
                var candidate = Uri.UnescapeDataString(kvp[1]);
                if (candidate.StartsWith("/"))
                {
                    returnUrl = candidate;
                }
                break;
            }
        }
    }

    private async Task HandleRegister()
    {
        error = null;
        showSuccessToast = false;
        UpdateConfirmPasswordError();

        if (!string.IsNullOrEmpty(confirmPasswordError))
        {
            return;
        }

        if (registerEditContext is not null && !registerEditContext.Validate())
        {
            return;
        }

        isLoading = true;

        var (result, errorMessage) = await Api.RegisterCustomerAsync(registerModel);

        isLoading = false;

        if (result is null)
        {
            error = errorMessage ?? "Registration failed.";
            return;
        }

        showSuccessToast = true;

        var target = string.IsNullOrWhiteSpace(returnUrl) ? "/customer" : returnUrl!;
        await Task.Delay(900);
        Navigation.NavigateTo(target, true);
    }

    public void Dispose()
    {
        if (registerEditContext is not null)
        {
            registerEditContext.OnFieldChanged -= RegisterFieldChanged;
        }
    }
}
