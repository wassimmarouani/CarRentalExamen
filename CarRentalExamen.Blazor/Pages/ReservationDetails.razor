@page "/reservations/details/{id:int}"
@attribute [Authorize]
@inject ApiClient Api

<PageTitle>Reservation Details</PageTitle>

@if (reservation is null)
{
    <p>Loading...</p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Reservation #@reservation.Id</h3>
        <div>
            <button class="btn btn-sm btn-success me-1" @onclick="Confirm">Confirm</button>
            <button class="btn btn-sm btn-warning me-1" @onclick="Pickup">Pickup</button>
            <button class="btn btn-sm btn-danger" @onclick="Cancel">Cancel</button>
        </div>
    </div>
    <p><strong>Car:</strong> @reservation.Car</p>
    <p><strong>Customer:</strong> @reservation.Customer</p>
    <p><strong>Period:</strong> @reservation.StartDate.ToShortDateString() - @reservation.EndDate.ToShortDateString()</p>
    <p><strong>Status:</strong> @reservation.Status</p>
    <p><strong>Total Price:</strong> $@reservation.TotalPrice</p>

    <h5>Options</h5>
    <ul>
        @foreach (var o in reservation.Options)
        {
            <li>@o.OptionName (@o.Quantity)x - $@o.PricePerDay /day</li>
        }
    </ul>

    <h5>Payments</h5>
    <ul class="list-group mb-3">
        @foreach (var p in reservation.Payments)
        {
            <li class="list-group-item d-flex justify-content-between">
                <span>@p.Method on @p.PaidAt.ToShortDateString()</span>
                <span>$@p.Amount (@p.Status)</span>
            </li>
        }
    </ul>
    <EditForm Model="paymentModel" OnValidSubmit="AddPayment">
        <div class="row g-2 mb-3">
            <div class="col-md-4">
                <InputNumber class="form-control" @bind-Value="paymentModel.Amount" placeholder="Amount" />
            </div>
            <div class="col-md-4">
                <InputText class="form-control" @bind-Value="paymentModel.Method" placeholder="Method" />
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-success" type="submit">Add Payment</button>
            </div>
        </div>
    </EditForm>

    <h5>Return</h5>
    <EditForm Model="returnModel" OnValidSubmit="Complete">
        <div class="row">
            <div class="col-md-3">
                <InputNumber class="form-control mb-2" @bind-Value="returnModel.ReturnMileage" placeholder="Return mileage" />
            </div>
            <div class="col-md-3">
                <InputNumber class="form-control mb-2" @bind-Value="returnModel.ReturnFuelLevel" placeholder="Fuel level" />
            </div>
            <div class="col-md-2">
                <InputNumber class="form-control mb-2" @bind-Value="returnModel.LateFees" placeholder="Late fees" />
            </div>
            <div class="col-md-2">
                <InputNumber class="form-control mb-2" @bind-Value="returnModel.DamageFees" placeholder="Damage fees" />
            </div>
            <div class="col-md-2">
                <InputNumber class="form-control mb-2" @bind-Value="returnModel.FuelFees" placeholder="Fuel fees" />
            </div>
        </div>
        <div class="mb-2">
            <InputText class="form-control" @bind-Value="returnModel.Notes" placeholder="Notes" />
        </div>
        <button class="btn btn-outline-primary" type="submit">Complete & Return</button>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }
    private ReservationDetailDto? reservation;
    private PaymentCreateDto paymentModel = new();
    private ReturnRequestDto returnModel = new();

    protected override async Task OnInitializedAsync()
    {
        paymentModel.ReservationId = id;
        returnModel.ReservationId = id;
        await Load();
    }

    private async Task Load()
    {
        reservation = await Api.GetReservationAsync(id);
    }

    private async Task Confirm()
    {
        await Api.ConfirmReservationAsync(id);
        await Load();
    }

    private async Task Cancel()
    {
        await Api.CancelReservationAsync(id);
        await Load();
    }

    private async Task Pickup()
    {
        await Api.PickupReservationAsync(id, null, null);
        await Load();
    }

    private async Task AddPayment()
    {
        await Api.AddPaymentAsync(paymentModel);
        paymentModel = new PaymentCreateDto { ReservationId = id };
        await Load();
    }

    private async Task Complete()
    {
        await Api.CreateReturnAsync(returnModel);
        await Load();
    }
}
